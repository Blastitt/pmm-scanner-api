<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8" />
<title>Pizza My Mind API Server</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.css" />
<link rel="stylesheet" href="/static/reset.css"/>
<link rel="stylesheet" href="/static/styles.css"/>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/randomcolor/0.4.1/randomColor.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>

var serverURL = 'https://pmm-rubyserverapps.rhcloud.com:8443';
var socket = null;

var response_callbacks = {};

if(window.location.hostname == 'localhost') {
	serverURL = 'http://localhost:7777';
}

try {
	socket = io.connect(serverURL);
} catch(e) {
	console.log('Error connecting to server.');
}

if(socket) {

	// admin has requested api access
	socket.on('registerapiemailresponse', function(data) {
		handleServerEmailRegisterResponse(data);
	});

	// student has requested to log in
	socket.on('registerapistudentidresponse', function(data) {
		handleServerStudentRegisterResponse(data);
	});

	// student has logged in, has requested survey questions
	socket.on('registerapistudentidsurveyresponse', function(data) {
		handleServerStudentRegisterSurveyResponse(data);
	});

	// admin has requested to log in
	socket.on('registerapiauthadminresponse', function(data) {
		handleServerAdminRegisterResponse(data);
	});

	// client has asked for database timestamp
	socket.on('registerapistudentidlastupdatedresponse', function(data) {
		handleStudentRegisterLastUpdatedResponse(data);
	});

	// student has requested last saved crn response
	socket.on('registerapistudentcrnresponse', function(data) {
		for(var i = 0; i < response_callbacks['registerapistudentcrnresponse'].length; i++) {
			response_callbacks['registerapistudentcrnresponse'][i].call(this, data);
		}
	});

	// client has requested spreadsheet generation from data
	socket.on('registerapiadmindownloadspreadsheetresponse', function(data) {
		for(var i = 0; i < response_callbacks['registerapiadmindownloadspreadsheetresponse'].length; i++) {
			response_callbacks['registerapiadmindownloadspreadsheetresponse'][i].call(this, data);
		}
	});

}

/**
 * Handle callback functions for specific server responses
 */
function onSocketResponse(eventName, callback) {

	if(!(typeof callback == 'function')) {
		return;
	}

	if(!response_callbacks[eventName]) {
		response_callbacks[eventName] = [];
	}

	response_callbacks[eventName].push(callback);

}

</script>
</head>
<body>
<div id="main-panel" class="panel">
	<div class="fx-shadow-overlay"></div><!--#fx-shadow-overlay-->
	<div class="wrapper">
		<div id="brand">
			<!-- <p class="logo">Scan Your ID</p>
			<p class="tagline">Please scan your ID to continue</p> -->
		</div><!--#brand-->

		<div class="stats" id="stats1">
			<div class="stats-out" id="stats1Out"></div><!--.stats-out-->
		</div><!--.circle-->

		<div class="panel-content">
			<div class="editor">
				<div class="editor-wrapper">
					<div class="editor-content Bloom-colorize">
						<!-- <div id="sid"></div> -->
						<input type="text" placeholder="Type your ID" id="sid-input" />
					</div><!--.editor-content-->
				</div><!--.editor-wrapper-->
			</div><!--.editor-->
		</div><!--.panel-content-->

		<div id="out">Made with <span class="fa fa-heart"></span> for the PCSE department</div>

	</div><!--#home-page-->

</div><!--#main-panel-->

<div class="panel" id="results-panel">
	<div class="nav-bar">
		<div class="nav-bar-logo"></div>
		<div class="nav-bar-text">Pizza My Mind API</div>
		<div class="nav-bar-exit" id="close-button"><span class="fa fa-close fa-lg"></span></div>
	</div><!--.nav-bar -->
	<div class="wrapper">
		<div class="panel-content">
			<div class="editor">
				<div class="editor-wrapper">
					<div class="editor-content" id="results-content">
						Loading, please wait....
					</div><!--.editor-content-->
				</div><!--.editor-wrapper-->
			</div><!--.editor-->
		</div><!--.panel-content-->
	</div><!--.wrapper-->
</div><!--.panel-->
<div id="overlay"></div><!--#overlay-->
<script>

var DEBUG = true;
var DEBUG_STUDENT_ID = '00754548'//'00814189';

var DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';
var PAGE_HOME = 'home';
var PAGE_REGISTER = 'register';
var PAGE_ADMIN = 'admin';

// question type definitions
var SURVEY_QUESTION_MULT_CHOICE = 1;
var SURVEY_QUESTION_FREE_RESP 	= 2;

var closeButton = document.getElementById('close-button');

var mainInput = document.getElementById('sid-input');
var mainOutput = document.getElementById('out');
var urlPieces = window.location.href.split('/api/');

var resultsPage = document.getElementById('results-panel');
var resultsContent = document.getElementById('results-content');
var homePage = document.getElementById('main-panel');

// application states
var isMainPage 				= false;
var isAdminEmailEntered 	= false;
var isAdminHashkeyEntered 	= false;
var isPage = PAGE_HOME;

var currentStudentId 		= null;

var extraCreditInputShowing = false;
var eventsTableStudentEmailShowing = false;

// page events
$(window).on('keydown', function(key) {

	if(key.keyCode == 27) {
		key.preventDefault();

		if(extraCreditInputShowing) {
			extraCreditInputShowing = false;
			return $('.extra-credit-input').fadeOut('normal');
		}

		if(eventsTableStudentEmailShowing) {
			eventsTableStudentEmailShowing = false;
			return $('.events-table-student-email').fadeOut('normal');
		}

		$(closeButton).trigger('click');
	}

});

// focus main input
if(mainInput) {
	mainInput.focus();
	$(mainInput).on('keypress', function(e) {
		handleKeypress(e.keyCode);
	});
}

// handle views based on URL
handleURL(window.location.href);

if(closeButton) {
	$(closeButton).on('click', function() {
		resultsPage.style.display = 'none';
		mainInput.value = '';
		handleViewByPageName(isPage);
	});
}

// determine if url parameters are being used
var params = urlPieces[1] ? urlPieces[1].split('/') : [];

if(!isMainPage && params[1] == 'email' && params[2]) {
	showRegisterResultsPage(params[2]);
}

// if debug use default student ID
if(DEBUG) {
	console.log('WARN', 'DEBUG mode is on.', 'Please be cautious to set DEBUG mode off before pushing.');
	showHomeSurveyPage(DEBUG_STUDENT_ID);
}

function handleURL(urlPieces) {

	isMainPage = false;
	
	var urlParams = urlPieces.split(window.location.host);
	var path = urlParams && urlParams.length > 1 ? urlParams[1] : null;
	
	if(path == '/api/register') {
		handleRegistrationView();
	} else if(path == '/clare' || path == '/admin') {
		handleAdminView();
	} else {
		handleMainView();
	}

}

function handleViewByPageName(isPage) {

	if(isPage == PAGE_ADMIN) {
		handleAdminView();
	} else if(isPage == PAGE_REGISTER) {
		handleRegistrationView();
	} else {
		handleMainView();
	}

}

function handleMainView() {

	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Type your ID';

	isMainPage = true;
	isPage = PAGE_HOME;

	homePage.style.display = 'block';

	if(mainInput) {
		mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
		mainInput.focus();
	}
}

function handleRegistrationView() {

	isPage = PAGE_REGISTER;
	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';
	
	if(!mainInput || !mainOutput) {
		return;
	}

	homePage.style.display = 'block';
	
	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	mainOutput.innerHTML = 'Press ENTER To continue signing up';
}

function handleAdminView() {

	isPage = PAGE_ADMIN;
	DEFAULT_MAIN_OUTPUT_PLACEHOLDER = 'Enter your email';

	if(!mainInput || !mainOutput) {
		return;
	}

	homePage.style.display = 'block';
	
	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	mainOutput.innerHTML = 'Press ENTER To continue';
}

function handleAdminAuthentication() {

	if(!isPage == PAGE_ADMIN) {
		return;
	}

	if(isAdminEmailEntered) {

		// determine if admin has entered api key
		// and authenticate with api server
		if(isAdminHashkeyEntered) {

			// reset admin state values
			isAdminEmailEntered 		= false;
			isAdminHashkeyEntered 		= false;

			// display results page and wait for server response
			showAdminResultsPage(mainInput.valueAdminEmail, mainInput.valueAdminHashKey);

			// reset admin input
			mainInput.valueAdminEmail 	= null;
			mainInput.valueAdminHashKey = null;

			return;
		}

		// if we made it this far, admin has entered email
		// and is submitting hashkey.
		mainInput.valueAdminHashKey = mainInput.value;
		isAdminHashkeyEntered = true;
		handleAdminAuthentication();
		return;
	}

	// if we made it this far, email has not been entered.
	// check input value for a valid email string
	if(!mainInput.value.match(/^[a-z\-\_\.]+(\.[0-9]+)*\@(cnu\.edu)/gi)) {
		mainInput.value = '';
		return mainInput.placeholder = 'Please enter a valid email';
	}

	// assume admin email is of correct format. Save it and continue reg process
	mainInput.valueAdminEmail = mainInput.value;
	isAdminEmailEntered = true;

	mainInput.value = '';
	mainInput.placeholder = 'Enter your API key';

}

// display all student event and course selection data
// for selected admin with email, key combination
function showAdminResultsPage(email, key) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';
	resultsContent.innerHTML = 'Loading, please wait...';

	if(socket) {
		socket.emit('registerapiauthadmin', {
			email: email,
			hash: key
		});
	
	}

}

function showRegisterResultsPage(email) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';
	resultsContent.innerHTML = 'Loading, please wait...';

	if(socket) {
		socket.emit('registerapiemail', {
			email: email
		});
	
	}
}

// display events for selected student id
function showHomeResultsPage(studentId) {

	// save to return to this page later
	currentStudentId = studentId;

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';
	resultsContent.innerHTML = 'Loading, please wait...';

	if(socket) {
		socket.emit('registerapistudentid', {
			id: studentId,
			context: 'general'
		});
	
	}
}

// display survey questions for selected student id
function showHomeSurveyPage(studentId) {

	mainInput.placeholder = DEFAULT_MAIN_OUTPUT_PLACEHOLDER;
	homePage.style.display = 'none';
	resultsPage.style.display = 'block';
	resultsContent.innerHTML = 'Loading, please wait...';

	if(socket) {
		socket.emit('registerapistudentidsurvey', {
			id: studentId
		});
	
	}

}

// received when an admin is authenticated with the
// server, or when an admin authentication response
// is received from the server
function handleServerAdminRegisterResponse(data) {
	
	if(data.error) {
		if(!data.authenticated) {
			return resultsContent.innerHTML = 'Incorrect email or API key. Please try again, or email <a href="mailto:clarem@cnu.edu">clarem@cnu.edu</a> for more information. This incident will be logged.';
		}

		return resultsContent.innerHTML = 'An error occurred while contacting the authentication server. Please try again later. (' + data.message + ')';
	}

	// if we have made it this far, assume the user logged in correctly
	// assume data has rows
	if(!data.entries) {
		return resultsContent.innerHTML = 'Unable to fetch event data from the database.';
	}

	var students = {};
	var studentCount = 0;

	for(var i = 0; i < data.entries.length; i++) {

		// initialize array for entry if not exists
		if(!students[data.entries[i].id]) {
			students[data.entries[i].id] = {
				id: data.entries[i].id,
				last: data.entries[i].last,
				first: data.entries[i].first,
				email: data.entries[i].email,
				gradyear: data.entries[i].gradyear,
				crn: data.entries[i].crn,
				events:[]
			};

			studentCount++;
		}

		// add new event
		students[data.entries[i].id].events.push({
			event_id: data.entries[i].event_id,
			event_name: data.entries[i].event_name,
			year: data.entries[i].year,
			semester: data.entries[i].semester
		});
	}

	resultsContent.innerHTML = '';

	/**
	 * Section one - students with two points of ec
	 */

	 var sectionOneStudents = [];
	 var sectionTwoStudents = [];
	 var sectionThreeStudents = [];

	// create top text
	var ecStudentCount = 0;
	var tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);	

	// draw table of students with 12 or more events
	var table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length < 12) {
			continue;
		}

		ecStudentCount++;
		sectionOneStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">two points of extra credit</span> and have gone to <span style="color:#7ce2ef;">twelve or more events</span>. <span id="students_extra_credit_2" class="download-excel download-excel-two-points">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';


	// separate last section from new section
	resultsContent.innerHTML += '<div class="spacer"></div>';

	/**
	 * Section two - students with one point of ec
	 */

	// create view for students with one point of extra credit
	// reset count and dom pointers
	ecStudentCount = 0;
	tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);

	// draw table of students with 12 or more events
	table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length < 8 || students[i].events.length > 11) {
			continue;
		}

		ecStudentCount++;
		sectionTwoStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">one point of extra credit</span> and have gone to <span style="color:#7ce2ef;">eight or more events</span>. <span id="students_extra_credit_1" class="download-excel download-excel-one-point">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';

	// separate last section from new section
	resultsContent.innerHTML += '<div class="spacer"></div>';

	/**
	 * Section three - students with no points of ec
	 */

	// create view for students with zero point of extra credit
	// reset count and dom pointers
	ecStudentCount = 0;
	tableSpan = document.createElement('span');
	tableSpan.innerHTML = 'Loading, please wait...';

	resultsContent.appendChild(tableSpan);

	// draw table of students with 12 or more events
	table = document.createElement('table');
	table.className = 'events-table';
	table.border = '0';

	for(var i in students) {

		if(students[i].events.length > 7) {
			continue;
		}

		ecStudentCount++;
		sectionThreeStudents.push(students[i]);

		var tr = document.createElement('tr');
		var color = randomColor({
			luminosity: 'light',
			hue: 'blue'
		});

		tr.innerHTML = '<td style="color:' + color + ';min-width:225px;"><span class="events-table-student-email"><a href="mailto:' + students[i].email + '">' + students[i].email + '</a></span><span class="events-table-student-entry">' + students[i].first + ' ' + students[i].last + '</span></td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + students[i].events.length + ' events' + '</td>';
		tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + (students[i].crn ? students[i].crn : '<span style="opacity:0.45;">No course chosen</span>') + '</td>';
		table.appendChild(tr);
	}

	resultsContent.appendChild(table);

	// update stats
	tableSpan.innerHTML = 'Displaying <span style="color:rgb(189,224,216)">' + ecStudentCount + ' students</span> that have earned <span style="color:rgb(224,189,215);">zero points of extra credit</span> and have gone to <span style="color:#7ce2ef;">less than eight events</span>. <span id="students_extra_credit_0" class="download-excel download-excel-no-points">Click to <span style="color:#b4a9fc;">download spreadsheet</span></span>.';

	// add event listeners to table rows
	$('.events-table-student-entry').on('click', function() {
		eventsTableStudentEmailShowing = true;
		$(this.parentNode.getElementsByClassName('events-table-student-email').item(0)).fadeIn('normal');
	});

	$('.download-excel').on('click', function() {

		if(this.isBusy) {
			return;
		}

		var that = this;
		var clientData = {
			filename: 'students_extra_credit_NOpts.csv',
			entries: sectionThreeStudents
		};

		if(this.id == 'students_extra_credit_2') {
			clientData.filename = 'students_extra_credit_2pts.csv';
			clientData.entries = sectionOneStudents;
		} else if(this.id == 'students_extra_credit_1') {
			clientData.filename = 'students_extra_credit_1pts.csv';
			clientData.entries = sectionTwoStudents;
		}

		this.isBusy = true;
		$(this).animate({ opacity: 0.5 }, 500);

		// send data to server, wait for response
		// containing url to generated xlsx file
		socket.emit('registerapiadmindownloadspreadsheet', clientData); 

		onSocketResponse('registerapiadmindownloadspreadsheetresponse', function(data) {
			that.isBusy = false;
			$(that).animate({ opacity: 1.0 }, 500);
			window.location.assign(data.url);
		});

	});

}

/**
 * Called once the client returns database update data
 * Should only be called once per results page
 */
function handleStudentRegisterLastUpdatedResponse(data) {

	if(!data.timestamp) {
		return
	}

	// convert timestamp to date
	var date = new Date(parseInt(data.timestamp));

	// last updated div
	var divLastUpdated = document.createElement('div');
	divLastUpdated.className = 'events-last-updated';
	divLastUpdated.innerHTML = 'Event data last updated on ' + (date.getMonth() + 1) + '/' + date.getDate() + '/' + date.getFullYear();
	resultsContent.appendChild(divLastUpdated);

}

/**
 * Called once server responds with event data for the current
 * student ID.
 */
function handleServerStudentRegisterResponse(data) {

	// replace table id underscores with slashes
	function tableIdToDate(id) {
		return id.replace(/\_/gi, '\/');
	}

	if(data && data.entries.length) {

		var fullName = 'stranger';

		// populate first and last name if possible
		if(data.entries[0].first && data.entries[0].last) {
			fullName = data.entries[0].first + ' ' + data.entries[0].last;
		}

		// if we got this far, we have made a request for student data after receiving
		// zero event records last time
		if(data.context == 'students') {
			return resultsContent.innerHTML = '<h1>Welcome, you have not been to <span style="color:rgb(189,198,224);font-weight:bold;">any Pizza My Mind events</span> this semester. Come listen to great companies present opportunities they have to offer <span style="color:rgb(224,189,215);font-weight:bold;">Thursdays at 12:15pm</span> in <span style="color:rgb(189,224,216);font-weight:bold;">Luter 121</span>.</h1>';
		}

		var divCourseInfo = document.createElement('span');
		divCourseInfo.className = 'course-info';

		var extraCredit = 0;
		var plural = 's';
		var evtPlural = 's';

		if(data.entries.length >= 8) {
			extraCredit = 1;
			if(data.entries.length >= 12) {
				extraCredit = 2;
			}
		}

		if(extraCredit == 1) {
			plural = '';
		}

		if(data.entries.length == 1) {
			evtPlural = '';
		}

		resultsContent.innerHTML = '<h1>Welcome, you have been to <span style="color:rgb(189,198,224);font-weight:bold;">' + data.entries.length + ' event' + evtPlural + '</span> this semester and qualify for <span style="color:rgb(224,189,215);font-weight:bold;">' + extraCredit + ' point' + plural + ' of extra credit</span> in any eligible course.</h1>';

		resultsContent.appendChild(divCourseInfo);

		// draw table
		var table = document.createElement('table');
		table.className = 'events-table';
		table.border = '0';

		for(var i = 0; i < data.entries.length; i++) {
			var tr = document.createElement('tr');
			var color = randomColor({
				luminosity: 'light',
				hue: 'blue'
			});
			tr.innerHTML = '<td style="color:' + color + ';">' + tableIdToDate(data.entries[i].event_id) + '</td>';
			tr.innerHTML += '<td style="text-align:right;color:' + color + ';">' + data.entries[i].event_name + '</td>';
			table.appendChild(tr);
		}

		resultsContent.appendChild(table);

		// ask server to send database last updated timestamp
		socket.emit('registerapistudentidlastupdated');

		// populate information on course chosen by student
		// only if student is eligible for bonus points
		if(data.entries.length >= 8) {

			var extraCreditInput = document.createElement('input');
			extraCreditInput.type = "text";
			extraCreditInput.className = "extra-credit-input";
			extraCreditInput.placeholder = "Enter a Course Registration Number (" + (data.entries[0].crn ? data.entries[0].crn : 'CRN') + ")";

			// add input keydown event handler
			$(extraCreditInput).on('keydown', function(key) {

				if(key.keyCode == 13 && this.value != '') {
					
					if(!this.value.match(/^[0-9]{4}$/gi)) {
						this.value = '';
						this.placeholder = 'Please enter a valid CRN';
						return;
					}

					// assume valid crn was entered
					var crn = this.value;
					var old_crn = data.entries[0].crn;
					this.value = '';
					this.placeholder = "Enter a Course Registration Number (" + (old_crn ? old_crn : 'CRN') + ")";

					$(this).fadeOut('normal');

					if(!old_crn) {
						$('.extra-credit-text').html("You are <span style='color:#7ebfea;'>applying extra credit</span> to course <span id='extra-credit-crn' style='color:#77e6ea;'>" + crn + "</span>.");

					} else {
						$('#extra-credit-crn').html(crn);
					}

					// ask server to update CRN for current student
					socket.emit('registerapistudentcrn', {
						id: data.id,
						crn: crn
					});

					// prepare for response
					onSocketResponse('registerapistudentcrnresponse', function(data) {

						if(data.error) {
							return $('#extra-credit-crn').html(old_crn);
						}

						$('#extra-credit-crn').html(data.crn)

					});
				}

			});

			// append crn input
			divCourseInfo.appendChild(extraCreditInput);

			var extraCreditText = document.createElement('h1');
			extraCreditText.className = "extra-credit-text";
			extraCreditText.innerHTML = 'You have <span style="color:#7ebfea;">not yet selected a course</span> to apply extra credit. <span style="color:#77e6ea;">Click to begin</span>.';

			// append crn text
			divCourseInfo.appendChild(extraCreditText);

			// A course has been chosen if at least
			// one entry contains a valid CRN
			if(data.entries[0].crn) {
				extraCreditText.innerHTML = "You are <span style='color:#7ebfea;'>applying extra credit</span> to course <span id='extra-credit-crn' style='color:#77e6ea;'>" + data.entries[0].crn + "</span>.";
			}

			// if we made it this far, assume eligible but has not
			// chosen course yet. Add prompt to choose course
			// extraCreditInput.style.display = "block";
			
			// text event listener
			$(extraCreditText).on('click', function() {
				extraCreditInputShowing = true;
				$(extraCreditInput).fadeIn('normal');
				$(extraCreditInput).focus();
			});

		}

	} else if(data.context != 'students') {
		// get student data if we received no
		// data initially and we still wish to
		// receive student information with no
		// events->students relationship
		socket.emit('registerapistudentid', {
			id: data.id,
			context: 'students'
		});
	} else {
		// if we have made it this far, the student is not
		// in the database
		resultsContent.innerHTML = '<h1>Hey there, you have not yet shown up to any Pizza My Mind events. Come listen to <span style="color:rgb(189,198,224);font-weight:bold;">great companies</span> <span style="color:rgb(189,224,216);font-weight:bold;">present unique opportunities</span> to students <span style="color:rgb(224,189,215);font-weight:bold;">Thursdays at 12:20pm</span> in <span style="color:rgb(189,224,216);font-weight:bold;">Luter 121</span>.</h1>';
	}
}

/**
 * Called once server responds with survey data for the current
 * student ID.
 */
function handleServerStudentRegisterSurveyResponse(data) {

	var questions = {};
	
	for(var i = 0; i < data.entries.length; i++) {

		if(!questions[data.entries[i].question_id]) {
			questions[data.entries[i].question_id] = {
				student_id: data.id,
				question_id: data.entries[i].question_id,
				question: data.entries[i].question,
				type: data.entries[i].type,
				choices: []
			}
		}

		questions[data.entries[i].question_id].choices.push(data.entries[i].choice);

	}

	resultsContent.innerHTML = '<h1>Pizza My Mind Survey</h1>';

	var parsedQuestions = [];

	var questionsContainer = document.createElement('div');
	questionsContainer.className = 'survey-question-container';

	// iterate through questions
	for(var i in questions) {

		// save parsed question
		parsedQuestions.push(questions[i]);

		// save assigned question index
		questions[i]._index = parsedQuestions.length - 1;

		var surveyQuestion = document.createElement('div');
		surveyQuestion.className = 'survey-question';

		var surveyQuestionHeader = document.createElement('span');
		surveyQuestionHeader.className = 'question_header';
		surveyQuestionHeader.innerHTML = '<span class="question_num">' + parsedQuestions.length + '.</span> ';
		surveyQuestionHeader.innerHTML += '<span class="question_title">' + questions[i].question + '</span>';

		var surveyQuestionBody = document.createElement('span');
		surveyQuestionBody.className = 'question_body';


		if(questions[i].type == SURVEY_QUESTION_MULT_CHOICE) {

			for(var x = 0; x < questions[i].choices.length; x++) {

				var surveyQuestionChoice = document.createElement('span');
				surveyQuestionChoice.className = 'question_choice';
				surveyQuestionChoice.question_index = parsedQuestions.length - 1;
				surveyQuestionChoice.innerHTML = questions[i].choices[x];
				
				$(surveyQuestionChoice).on('click', function() {

					for(var y = 0; y < this.parentNode.children.length; y++) {
						this.parentNode.children[y].style.backgroundColor = '';
						this.parentNode.children[y].style.color = '';
					}

					this.style.backgroundColor = '#9ea2ff';
					this.style.color = 'rgb(0,5,108)';
					parsedQuestions[this.question_index].response = this.innerHTML;
				});

				surveyQuestionBody.appendChild(surveyQuestionChoice);
			}

		} else if(questions[i].type == SURVEY_QUESTION_FREE_RESP) {

		}

		surveyQuestion.appendChild(surveyQuestionHeader);
		surveyQuestion.appendChild(surveyQuestionBody);
		questionsContainer.appendChild(surveyQuestion);
	}

	resultsContent.appendChild(questionsContainer);
	console.log(parsedQuestions);

}

/**
 * Called once server responds with API registration data
 */
function handleServerEmailRegisterResponse(data) {

	if(data.error && data.unauthorized) {
		return resultsContent.innerHTML = 'You do not have permission to request access to this API. Please contact <a href="mailto:clarem@cnu.edu">Clare Maliniak</a> for more information.';
	}

	if(data.error && !data.unauthorized) {
		return resultsContent.innerHTML = 'An error occurred processing your request. Don\'t worry, it\'s not your fault! Please try again later.';
	}

	// email is authorized, exists in database
	// but is already active, email out key
	if(data.entry && data.entry.isActive && data.entry.hashKey) {
		return resultsContent.innerHTML = 'You have already requested access to this API. Please check your email. Your existing key has been sent to you.';
	}

	// email is authorized, exists in database
	// is not active, get hash returned by the server
	resultsContent.innerHTML = 'Thank you for your interest in creating with the Pizza Mind API.<br /><br />';
	resultsContent.innerHTML += 'An email has been sent to you containing your access key.<br />';
	resultsContent.innerHTML += 'To use the API, simply send an "Authentication" header with your request, containing the value "email=YOUR_EMAIL; key=KEY_HASH_EMAILED_TO_YOU"';
}

function handleKeypress(key) {

	if(key == 13) {

		if(!mainInput || mainInput.value == '') {
			return;
		}

		if(!isMainPage) {

			if(isPage == PAGE_REGISTER) {

				var cnuEmail = mainInput.value;

				if(!mainInput.value.match(/^[a-z\-\_\.]+(\.[0-9]+)*\@(cnu\.edu)$/gi)) {
					mainInput.value = '';
					mainInput.placeholder = 'Enter a valid CNU email';
					return;
				}

				mainInput.value = '';
				mainInput.placeholder = 'Loading, please wait...';

				return showRegisterResultsPage(cnuEmail);

			} else if(isPage == PAGE_ADMIN) {
				return handleAdminAuthentication();
			}
		}

		var studentId = mainInput.value;

		// assume we are submitting student ID
		if(!mainInput.value.match(/^(0*)[0-9]{5,8}$/gi)) {
			mainInput.value = '';
			mainInput.placeholder = 'Please enter a valid ID';
			return;
		}

		mainInput.value = '';
		mainInput.placeholder = 'Loading, please wait...';

		return showHomeResultsPage(studentId);
	
	}
}

</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-62273783-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>